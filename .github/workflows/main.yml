name: Download and Combine Proxy Lists (Advanced Deduplication)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write # Memberikan izin tulis ke GITHUB_TOKEN untuk mengakses konten repositori

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download proxy list 1
      run: |
        curl -o proxy_list_1.txt https://raw.githubusercontent.com/h58fmb0344g9h3/p57gdv3j3n0vg334/refs/heads/main/f74bjd2h2ko99f3j5

    - name: Download proxy list 2
      run: |
        curl -o proxy_list_2.txt https://raw.githubusercontent.com/FoolVPN-ID/Nautica/refs/heads/main/proxyList.txt

    - name: Combine and deduplicate proxy lists based on IP and Port
      run: |
        # Gabungkan kedua file
        cat proxy_list_1.txt proxy_list_2.txt > combined_proxies_raw.txt

        # Gunakan awk untuk menghapus duplikasi berdasarkan dua kolom pertama (IP dan Port)
        # -F, : Menggunakan koma sebagai pemisah field
        # {key = $1 "," $2} : Membuat kunci unik dari kolom pertama dan kedua
        # !seen[key]++ : Jika kunci belum terlihat, cetak baris dan tandai sebagai terlihat
        # Hasilnya akan mempertahankan baris pertama yang ditemukan untuk setiap kombinasi IP dan Port yang unik.
        awk -F, '!seen[$1","$2]++' combined_proxies_raw.txt > proxy_ip.txt

    - name: Upload combined proxy list as artifact
      uses: actions/upload-artifact@v4
      with:
        name: combined-proxy-list
        path: proxy_ip.txt
        retention-days: 7

    - name: Commit and push changes (optional)
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add proxy_ip.txt
        git commit -m "Update proxy_ip.txt with latest combined lists and deduplicated by IP/Port" || echo "No changes to commit"
        git push
